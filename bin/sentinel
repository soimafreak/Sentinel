#!/usr/bin/ruby

#################################################################
#
#   Sentinel - Self healing application monitor
#
#   Author:         Matthew Smith <soimafreak@gmail.com>
#   Site:           http://sentinel.soimafreak.co.uk/
#   Purpose:        Check health of a process through various means and keep said process operating correctly
#   Date:           27th March 2012
#   Explination:    Sentinel will carry out a number of checks on the health of the application / system 
#                   based on the outcome of these checks certain actions will be taken
#   Requires:       gem install -r log4r
#   Thanks:         http://angrez.blogspot.co.uk/2006/12/log4r-usage-and-examples.html
#
#   Copyright:      Copyright (C) 2012, Matthew Smith 
#   License:
#   This program is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#################################################################

#
#   Requires
#
require 'sentinel'

#
#   initiate vars
#

sentinel = Sentinel.new

hash_of_processes = Hash.new 
hash_of_bad_processes = Hash.new 
hash_of_disks = Hash.new 
hash_of_memory = Hash.new
hash_of_app_memory = Hash.new

#
#   Check Process health
#

hash_of_processes = sentinel.get_app_details()
hash_of_bad_processes = sentinel.check_process_state(hash_of_processes)
scores.processes = sentinel.score_calc_process_numbers(hash_of_bad_processes)
scores.process_state = sentinel.score_calc_process(hash_of_bad_processes) 
$log.info "Process_state score = #{scores.process_state}"
$log.info "Processes score = #{scores.processes}"

#
#   Check system health
#

#   Check Disks
hash_of_disks = get_disks()
hash_of_disks = check_disk_utilisation(hash_of_disks)
scores.disk_utilisation = score_calc_disk_utilisation(hash_of_disks)
$log.info "Disk utilisation score = #{scores.disk_utilisation}"

#   Check memory
hash_of_memory = get_system_memory()
scores.memory = score_calc_memory(hash_of_memory)
$log.info "Memory utilisation score = #{scores.memory}"

# hash of processes contains the info from get_app_details
hash_of_app_memory = check_app_memory(hash_of_processes)
scores.application = score_calc_app_memory(hash_of_app_memory) 
$log.info "Application Memory utilisation score = #{scores.application}"

if (options[:application_url_check] != nil)
    if (options[:application_search_term] != nil)
        scores.application_url = score_app_url()
        $log.info "Application check URL score = #{scores.application_url}"
    else
        $log.warn "No search term set for URL check"
    end
else
    $log.warn "No URL specified for URl check"
end
if (scores.process_state >= options[:process_bad_percentage])
    sentinel.action_process_state(hash_of_bad_processes)
end
